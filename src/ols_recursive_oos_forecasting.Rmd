
## Load Relevent Packages

```{r}
rm(list=ls())
library('readxl')
library('here')
library('dplyr')
library('lubridate')
library('urca')
library('tsDyn')
library('data.table')
library('purrr')
library('tidyr')
library('ggplot2')
library('Metrics')
```

## Define Parameters of the Study

```{r}
SPOTS = c(
  'USDSGD', 'USDKRW', 'USDMYR', 'USDCNY', 'USDTHB',
  'USDIDR', 'USDTWD', 'USDINR', 'USDTWD', 'USDJPY'
  # 'USDAUD', 'USDEUR', 'USDGBP'
)

FWD_NAMES = c(
  '1M', '2M', '3M', '6M', '12M', '2Y'
)

FWD_NAMES_MAPPINGS = c(
  '1M' = 1, '2M' = 2, '3M' = 3, '6M' = 6, '12M' = 12, '2Y' = 24
)

INPUT_PATH = here('src', 'data', 'inputs')
CCYS_FILE_NAME = 'daily-currencies-forwards.xlsx'
TRAIN_END_DATE = '2005-01-01'
```

## Load Data

```{r}
ccy_list = list()
for (ccy in SPOTS) {
  daily_currencies_forwards <- read_excel(
    file.path(INPUT_PATH, CCYS_FILE_NAME),
    sheet = ccy
  )
  selected_ccy <- daily_currencies_forwards %>% select(date, paste0(ccy, ' Curncy'))
  ccy_list[[ccy]] <- selected_ccy
}

# Merge all the data into one dataframe using the date column
ccy_df <- Reduce(function(x, y) merge(x, y, by = 'date', all = TRUE), ccy_list)

# Resample prices to monthly frequency by the last observation of the month
ccy_df$date <- ymd(ccy_df$date)
ccy_df <- ccy_df %>% group_by(year(date), month(date)) %>% slice(n()) %>% ungroup() %>%
  arrange(date) %>% select(-`year(date)`, -`month(date)`) %>% tidyr::drop_na()

monthly_currencies_forwards <- daily_currencies_forwards %>%
  group_by(year = year(date), month = month(date)) %>%
  slice_max(order_by = date, n = 1) %>%
  ungroup() %>%
  arrange(date) %>%
  select(-year, -month)

# Select train and test data
train_ccy_df <- ccy_df %>% filter(date <= TRAIN_END_DATE)
train_dates <- train_ccy_df$date
train_ccy_df <- train_ccy_df %>% select(-date)
test_ccy_df <- ccy_df %>% filter(date > TRAIN_END_DATE)
test_dates <- test_ccy_df$date
test_ccy_df <- test_ccy_df %>% select(-date)
```

```{r}
train_curve_list = list()
test_curve_list = list()
for (fwd in FWD_NAMES) {
  fwd_list = list()
  for (ccy in SPOTS) {
    col_types <-  c('date', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric')
    daily_currencies_forwards <- read_excel(
      file.path(INPUT_PATH, CCYS_FILE_NAME),
      sheet = ccy,
      col_types = col_types
    )
    
    
    selected_ccy <- daily_currencies_forwards %>% select(date, paste0(ccy, fwd, ' Curncy'))
    fwd_list[[ccy]] <- selected_ccy
  }
  # Merge all the data into one dataframe using the date column
  fwd_df <- Reduce(function(x, y) merge(x, y, by = 'date', all = TRUE), fwd_list)
  
  # Resample prices to monthly frequency by the last observation of the month
  fwd_df$date <- ymd(fwd_df$date)
  fwd_df <- fwd_df %>% group_by(year(date), month(date)) %>% slice(n()) %>% ungroup() %>%
    arrange(date) %>% select(-`year(date)`, -`month(date)`) %>% tidyr::drop_na()
  
  # Select train and test data
  train_fwd_df <- fwd_df %>% filter(date <= TRAIN_END_DATE)
  train_fwd_dates <- train_fwd_df$date
  train_fwd_df <- train_fwd_df %>% select(-date)
  test_fwd_df <- fwd_df %>% filter(date > TRAIN_END_DATE)
  test_fwd_dates <- test_fwd_df$date
  test_fwd_df <- test_fwd_df %>% select(-date)

  train_curve_list[[fwd]] <- train_fwd_df
  test_curve_list[[fwd]] <- test_fwd_df
}
```

## Recursive Forecasting of the Test Data

```{r}
# Setup
n_test       <- nrow(test_ccy_df)
selected_lag <- 1
h            <- 24  # maximum horizon

# Initialize empty lists of data.tables per horizon
FWD_NAMES <- names(FWD_NAMES_MAPPINGS)

forecasts_list     <- setNames(vector("list", length(FWD_NAMES)), FWD_NAMES)
actuals_list       <- setNames(vector("list", length(FWD_NAMES)), FWD_NAMES)
forecasts_rw_list  <- setNames(vector("list", length(FWD_NAMES)), FWD_NAMES)
forecasts_fwd_list <- setNames(vector("list", length(FWD_NAMES)), FWD_NAMES)

for (fwd in FWD_NAMES) {
  forecasts_list[[fwd]]     <- data.table()
  actuals_list[[fwd]]       <- data.table()
  forecasts_rw_list[[fwd]]  <- data.table()
  forecasts_fwd_list[[fwd]] <- data.table()
}

betas_sgd <- list()

# Loop over the test set
for (i in seq_len(n_test - 1)) {
  current_data <- rbind(train_ccy_df, test_ccy_df[1:i, ])
  
  tail(current_data, 1)
  
  current_data <- log(current_data)
  
  pred_ols <- list()
  betas <- list()

  for (ccy in c("USDSGD")) {
    ols_model <- lm(
      as.formula(paste0('`', ccy, ' Curncy` ~ . -1')),
      data = current_data
    )

    tmp_betas <- ols_model$coefficients
    tmp_X <- current_data[nrow(current_data), ]
    tmp_X[[ccy]] <- NULL

    betas_names <- gsub('`', '', names(tmp_betas))
    tmp_X <- tmp_X[match(betas_names, names(tmp_X))]

    tmp_pred_ols_log <- sum(tmp_X * tmp_betas)
    tmp_pred_ols <- exp(tmp_pred_ols_log)

    tmp_pred_ols <- data.frame(ccy = rep(tmp_pred_ols, h)) %>%
      rename(!!paste0(ccy, ' Curncy') := ccy)
    row.names(tmp_pred_ols) <- nrow(current_data) + seq(1, h)

    pred_ols[[ccy]] <- tmp_pred_ols
    betas[[ccy]] <- tmp_betas
    if (ccy == 'USDSGD') {
      betas_sgd[[i]] <- tmp_betas
    }
  }

  pred_ols <- do.call(cbind, pred_ols) %>% as.data.frame()
  
  for (fwd in FWD_NAMES) {
    horizon_idx <- FWD_NAMES_MAPPINGS[[fwd]]

    # VECM forecast
    tmp_pred_ols <- pred_ols[horizon_idx, ]
    forecasts_list[[fwd]] <- rbind(forecasts_list[[fwd]], as.data.table(as.list(tmp_pred_ols)))

    # Actuals
    actual_row <- i + horizon_idx
    if (actual_row <= n_test) {
      tmp_true <- test_ccy_df[actual_row, ]
      actuals_list[[fwd]] <- rbind(actuals_list[[fwd]], as.data.table(as.list(tmp_true)))
    }

    # Forward forecast
    tmp_fwd <- test_curve_list[[fwd]][i, ]
    forecasts_fwd_list[[fwd]] <- rbind(forecasts_fwd_list[[fwd]], as.data.table(as.list(tmp_fwd)))

    # Random walk
    tmp_rw <- exp(current_data[dim(current_data)[1], ])
    forecasts_rw_list[[fwd]] <- rbind(forecasts_rw_list[[fwd]], as.data.table(as.list(tmp_rw)))
  }
}
```

```{r}
tmp_betas
```

```{r}
complete_cases_vector_pairs <- function(f, a) {
  valid_idx <- complete.cases(f, a)
  df <- data.frame(f, a)
  df <- df[complete.cases(df), ]
  return(df)
}

summary <- list()
i <- 1
for (h in FWD_NAMES) {
  for (ccy_name in SPOTS) {
    # predictions
    model_forecast <- forecasts_list[[h]][[paste0(ccy_name, ' Curncy')]]
    fwd_forecast <- forecasts_fwd_list[[h]][[paste0(ccy_name, h, ' Curncy')]]
    rw_forecast <- forecasts_rw_list[[h]][[paste0(ccy_name, ' Curncy')]]
    
    # real values
    actual_forecast <- actuals_list[[h]][[paste0(ccy_name, ' Curncy')]]
    
    n_dim_forecast <- length(model_forecast)
    n_dim_actual <- length(actual_forecast)
    if (n_dim_forecast != n_dim_actual) {
      model_forecast <- model_forecast[1:n_dim_actual]
    }
    
    n_dim_fwd <- length(fwd_forecast)
    if (n_dim_fwd != n_dim_actual) {
      fwd_forecast <- fwd_forecast[1:n_dim_actual]
    }
    
    n_dim_rw <- length(rw_forecast)
    if (n_dim_rw != n_dim_actual) {
      rw_forecast <- rw_forecast[1:n_dim_actual]
    }
    
    # complete cases using complete_cases_vector_pairs
    model_forecast_df <- complete_cases_vector_pairs(model_forecast, actual_forecast)
    fwd_forecast_df <- complete_cases_vector_pairs(fwd_forecast, actual_forecast)
    rw_forecast_df <- complete_cases_vector_pairs(rw_forecast, actual_forecast)
    
    tmp_summary <- data.frame(
      h = h,
      ccy = ccy_name,
      rmse_model = rmse(model_forecast_df$f, model_forecast_df$a),
      rmse_fwd = rmse(fwd_forecast_df$f, fwd_forecast_df$a),
      rmse_rw = rmse(rw_forecast_df$f, rw_forecast_df$a)
    )
    summary[[i]] <- tmp_summary
    i <- i + 1
  }
}
summary_df <- do.call(rbind, summary) %>% as.data.table()

# build ratios
summary_df <- summary_df %>%
  mutate(
    model_ratio = rmse_model / rmse_rw,
    fwd_ratio = rmse_fwd / rmse_rw
  ) %>%
  rename(
    Tenor = h,
    Currency = ccy,
    OLS_RMSE_Ratio = model_ratio,
    FWD_RMSE_Ratio = fwd_ratio
  )
```

```{r}
summary_df %>% filter(Currency == "USDSGD")
```


```{r}
# Prepare long format for plotting
plot_data <- summary_df %>%
  select(Tenor, Currency, OLS_RMSE_Ratio, FWD_RMSE_Ratio) %>%
  pivot_longer(cols = c(OLS_RMSE_Ratio, FWD_RMSE_Ratio),
               names_to = "Model", values_to = "RMSE_Ratio")

# Optional: clean model names
plot_data$Model <- recode(plot_data$Model,
                          OLS_RMSE_Ratio = "OLS",
                          FWD_RMSE_Ratio  = "FWD")

# Plot
ggplot(plot_data, aes(x = Tenor, y = RMSE_Ratio, color = Model, group = Model)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  facet_wrap(~ Currency, scales = "free_y") +
  labs(
    title = "RMSE Ratio (OLS / RW) per Currency",
    y = "RMSE Ratio",
    x = "Tenor"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    strip.text = element_text(size = 10, face = "bold")
  )
```

```{r}
ccy_name <- "USDSGD Curncy"
fwd <- "12M"
ovrd <- 12

model_forecast <- forecasts_list[[fwd]][[ccy_name]]
actual <- actuals_list[[fwd]][[ccy_name]]

forecast_df <- complete_cases_vector_pairs(model_forecast, actual)
subtract <- length(test_dates) - ovrd
forecast_df$date <- test_dates[1:subtract]

# time series plot
ggplot(forecast_df, aes(x = date)) +
  geom_line(aes(y = f, color = "Forecast"), size = 1) +
  geom_line(aes(y = a, color = "Actual"), size = 1) +
  labs(
    title = paste("Forecast vs Actual for ", ccy_name, "-", fwd),
    y = "Value",
    x = "Date"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    strip.text = element_text(size = 10, face = "bold")
  )
```


